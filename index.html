<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>インポートCSV作成補助システム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.2s ease-in-out; }
        .drop-zone.drag-over { border-color: #3b82f6; background-color: #eff6ff; }
        .chat-bubble { max-width: 80%; }
        .chat-bubble.user { background-color: #3b82f6; color: white; }
        .chat-bubble.ai { background-color: #e5e7eb; color: #1f2937; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-slate-200 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <!-- ヘッダー -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-900">インポートCSV作成補助システム</h1>
            <p class="text-slate-600 mt-2">メインシステムに取り込むCSVファイルを、効率的に整形・分析します。</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 左側: 操作パネル -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- ステップ1: ファイルアップロード -->
                <div class="p-6 rounded-lg shadow-md" style="background-color: #f2f6e5;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <i class="fa-solid fa-file-arrow-up mr-3 text-blue-500"></i>
                        ファイル選択
                    </h2>

                    <!-- S3から前回ファイルを取得するボタン -->
                    <div class="mb-4">
                        <button id="load-previous-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center justify-center">
                            <i class="fa-solid fa-cloud-arrow-down mr-2"></i>
                            <span>S3から前回ファイルを取得</span>
                        </button>
                        <p class="text-xs text-slate-500 mt-1 text-center">前回処理後のファイルを自動でセットします。</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="latest_file" class="block text-sm font-medium text-slate-700 mb-1">最新の案件ファイル (必須)</label>
                            <div id="latest-drop-zone" class="drop-zone rounded-md p-4 text-center cursor-pointer">
                                <i class="fa-solid fa-file-csv text-3xl text-slate-400"></i>
                                <p id="latest-file-name" class="mt-2 text-sm text-slate-500">ここにドラッグ＆ドロップ<br>またはクリックして選択</p>
                            </div>
                            <input type="file" id="latest_file" class="hidden" accept=".csv">
                        </div>
                        <div>
                            <label for="previous_file" class="block text-sm font-medium text-slate-700 mb-1">前回の案件ファイル (差分抽出用)</label>
                             <div id="previous-drop-zone" class="drop-zone rounded-md p-4 text-center cursor-pointer">
                                <i class="fa-solid fa-file-csv text-3xl text-slate-400"></i>
                                <p id="previous-file-name" class="mt-2 text-sm text-slate-500">ここにドラッグ＆ドロップ<br>またはクリックして選択</p>
                            </div>
                            <input type="file" id="previous_file" class="hidden" accept=".csv">
                        </div>
                    </div>
                </div>

                <!-- ステップ2: 処理オプション -->
                <div class="p-6 rounded-lg shadow-md" style="background-color: #ADD2F5;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <i class="fa-solid fa-gear mr-3 text-slate-500"></i>
                        処理オプション
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="filter_date_column" class="block text-sm font-medium text-slate-700">日付でフィルタリング</label>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <input type="text" id="filter_date_column" placeholder="日付列の名前 (例: 公示日)" value="公示日" class="bg-white block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <input type="date" id="filter_date_value" class="bg-white block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                            <p class="text-xs text-slate-500 mt-1">指定した日付以降の案件のみを抽出します。</p>
                        </div>
                        <div>
                            <label for="ai_date_column" class="block text-sm font-medium text-slate-700">AIで日付形式を統一</label>
                            <input type="text" id="ai_date_column" placeholder="日付列の名前 (例: 申請締切日)" value="工期／納期" class="bg-white mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">

                            <p class="text-xs text-slate-500 mt-1">「R7.7.1」等を「YYYY-MM-DD」形式に変換します。</p>
                        </div>
                    </div>
                    <hr class="my-4">
                        <div>
                            <label for="keyword_column" class="block text-sm font-medium text-slate-700">キーワードで絞り込み</label>
                            <input type="text" id="keyword_column" placeholder="検索したい列の名前 (例: 案件名)" value="案件名" class="bg-white mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <textarea id="keywords" placeholder="キーワードを改行で区切って入力&#10;例:&#10;PC&#10;導入" class="bg-white mt-2 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" rows="3"></textarea>
                            <div class="mt-2 flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input id="search_type_and" name="search_type" type="radio" value="AND" checked class="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <label for="search_type_and" class="ml-2 block text-sm text-slate-900">AND検索 (全てのキーワードを含む)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="search_type_or" name="search_type" type="radio" value="OR" class="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500">
                                    <label for="search_type_or" class="ml-2 block text-sm text-slate-900">OR検索 (いずれかのキーワードを含む)</label>
                                </div>
                            </div>
                        </div>
                </div>

                <!-- 実行ボタン -->
                <button id="process-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors text-lg flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-rocket mr-2"></i>
                    <span>処理実行</span>
                </button>

            </div>

            <!-- 右側: 結果表示とAIチャット -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 結果表示エリア -->
                <div id="result-area" class="p-6 rounded-lg shadow-md min-h-[300px]" style="background-color: #bfe0d3;">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">
                        <i class="fa-solid fa-square-poll-vertical mr-3 text-green-500"></i>
                        処理結果
                    </h2>
                    <div id="result-content" class="text-slate-500">
                        <p>ここに処理のログや結果のプレビューが表示されます。</p>
                    </div>
                    
                    <!-- ダウンロードボタン (初期状態は非表示) -->
                    <button id="download-btn" class="hidden mt-4 bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition-colors flex items-center">
                        <i class="fa-solid fa-download mr-2"></i>
                        結果をCSVでダウンロード
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 画面の部品を取得します ---
        const latestFileInput = document.getElementById('latest_file');
        const previousFileInput = document.getElementById('previous_file');
        const latestDropZone = document.getElementById('latest-drop-zone');
        const previousDropZone = document.getElementById('previous-drop-zone');
        const latestFileNameEl = document.getElementById('latest-file-name');
        const previousFileNameEl = document.getElementById('previous-file-name');
        const processBtn = document.getElementById('process-btn');
        const downloadBtn = document.getElementById('download-btn');
        const resultContent = document.getElementById('result-content');
        const loadPreviousBtn = document.getElementById('load-previous-btn');

        let processedCsvData = null; // 処理後のCSVデータを保持する変数

        // --- ドラッグ＆ドロップの動きを設定する関数（部品） ---
        function setupDropZone(dropZone, fileInput, fileNameEl) {
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    updateFileName(fileInput, fileNameEl);
                }
            });
            fileInput.addEventListener('change', () => {
                updateFileName(fileInput, fileNameEl);
            });
        }

        // --- ファイル名を表示する部分を更新する関数（部品） ---
        function updateFileName(fileInput, fileNameEl) {
            if (fileInput.files.length > 0) {
                fileNameEl.textContent = fileInput.files[0].name;
                fileNameEl.classList.add('text-blue-600', 'font-semibold');
            } else {
                fileNameEl.innerHTML = 'ここにドラッグ＆ドロップ<br>またはクリックして選択';
                fileNameEl.classList.remove('text-blue-600', 'font-semibold');
            }
        }

        // --- 作成した関数（部品）を、2つのドロップゾーンそれぞれに設定します ---
        setupDropZone(latestDropZone, latestFileInput, latestFileNameEl);
        setupDropZone(previousDropZone, previousFileInput, previousFileNameEl);

        // --- 「処理実行」ボタンが押された時の処理 ---
        processBtn.addEventListener('click', async () => {
            if (!latestFileInput.files[0]) {
                showError('「最新の案件ファイル」を選択してください。');
                return;
            }

            const formData = new FormData();
            // ファイルを追加
            formData.append('latest_file', latestFileInput.files[0]);
            if (previousFileInput.files[0]) {
                formData.append('previous_file', previousFileInput.files[0]);
            }
            // 日付フィルターの入力値を追加
            formData.append('filter_date_column', document.getElementById('filter_date_column').value);
            formData.append('filter_date_value', document.getElementById('filter_date_value').value);
            
            // キーワード検索の入力値を追加
            formData.append('keyword_column', document.getElementById('keyword_column').value);
            formData.append('keywords', document.getElementById('keywords').value);
            formData.append('search_type', document.querySelector('input[name="search_type"]:checked').value);

            // AI日付整形の入力値を追加
            formData.append('ai_date_column', document.getElementById('ai_date_column').value);

            showLoading('CSVファイルを処理中...');

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || '不明なエラーが発生しました。');
                }

                showResult(result);
                processedCsvData = result.csvData;

            } catch (error) {
                showError(error.message);
            }
        });

        // --- S3から前回ファイルを取得するボタンの処理 ---
        loadPreviousBtn.addEventListener('click', async () => {
            showLoading('S3から前回ファイルを取得中...');
            try {
                const response = await fetch('/api/load_previous');
                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `サーバーエラー: ${response.status}`);
                }
                const blob = await response.blob();
                const fileName = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'previous_file.csv';
                
                const file = new File([blob], fileName.replace(/"/g, ''), { type: 'text/csv' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                previousFileInput.files = dataTransfer.files;
                
                updateFileName(previousFileInput, previousFileNameEl);
                resultContent.innerHTML = `<p class="text-green-600 font-semibold">S3から前回ファイル「${fileName}」を正常に取得しました。</p>`;

            } catch (error) {
                showError(`S3からのファイル取得に失敗しました: ${error.message}`);
            }
        });

        // --- 結果のダウンロードボタンの処理 ---
        downloadBtn.addEventListener('click', () => {
            if (processedCsvData) {
                const blob = new Blob([processedCsvData], { type: 'text/csv;charset=utf-8-sig;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'processed_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // --- UIの表示を更新するための関数（部品）群 ---
        function showLoading(message) {
            resultContent.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-500 mr-3"></i>
                    <p class="text-slate-600">${message}</p>
                </div>
            `;
            downloadBtn.classList.add('hidden');
        }

        function showError(errorMessage) {
            resultContent.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md">
                    <p class="font-bold">エラー発生</p>
                    <p>${errorMessage}</p>
                </div>
            `;
            downloadBtn.classList.add('hidden');
        }
        
        function showResult(result) {
            const logHtml = result.log.map(line => `<li class="text-sm text-slate-600">${line}</li>`).join('');
            
            const rows = result.csvData.split('\n');
            if (rows.length < 2 || rows[0] === '') {
                 resultContent.innerHTML = `
                    <h3 class="font-semibold text-lg mb-2">処理ログ</h3>
                    <ul class="list-disc list-inside space-y-1 mb-6">${logHtml}</ul>
                    <h3 class="font-semibold text-lg mb-2">結果プレビュー (0行)</h3>
                    <p class="text-slate-500">処理の結果、該当するデータがありませんでした。</p>
                `;
                downloadBtn.classList.add('hidden');
                return;
            }

            const headers = rows[0].split(',');
            const bodyRows = rows.slice(1, 6);

            const tableHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                ${headers.map(h => `<th class="px-4 py-2 text-left font-semibold text-slate-600">${h.trim()}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
                            ${bodyRows.map(row => {
                                if (row.trim() === '') return '';
                                return `<tr>
                                    ${row.split(',').map(cell => `<td class="px-4 py-2 whitespace-nowrap">${cell.trim()}</td>`).join('')}
                                </tr>`
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${rows.length > 6 ? `<p class="text-xs text-slate-500 mt-2">...他 ${rows.length - 6} 行</p>` : ''}
            `;

            resultContent.innerHTML = `
                <h3 class="font-semibold text-lg mb-2">処理ログ</h3>
                <ul class="list-disc list-inside space-y-1 mb-6">${logHtml}</ul>
                <h3 class="font-semibold text-lg mb-2">結果プレビュー (${result.rowCount}行)</h3>
                ${tableHtml}
            `;
            downloadBtn.classList.remove('hidden');
        }
    });
    </script>
</body>
</html>